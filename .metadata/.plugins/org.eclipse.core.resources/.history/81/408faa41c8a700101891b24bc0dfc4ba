<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Estadísticas - McAulley</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>📊 Dashboard de Estadísticas</h1>
                <p class="text-muted">Métricas y análisis del sistema McAulley</p>
            </div>
            <div>
                <a th:href="@{/alumnas}" class="btn btn-outline-primary me-2">
                    <i class="fas fa-users"></i> Ver Alumnas
                </a>
                <a th:href="@{/}" class="btn btn-outline-secondary">
                    <i class="fas fa-home"></i> Inicio
                </a>
            </div>
        </div>

        <!-- Mensajes -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Tarjetas de Resumen -->
        <div class="row mb-4">
            <!-- Total Alumnas -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-start-primary border-3 h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                                    Total Alumnas
                                </div>
                                <div class="h5 mb-0 fw-bold text-gray-800" th:text="${estadisticas.total}"></div>
                                <div class="mt-2 text-sm">
                                    <span class="text-success">
                                        <i class="fas fa-calendar me-1"></i>
                                        Este mes: <strong th:text="${estadisticas.esteMes}"></strong>
                                    </span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-users fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alumnas Activas -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-start-success border-3 h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs fw-bold text-success text-uppercase mb-1">
                                    Alumnas Activas
                                </div>
                                <div class="h5 mb-0 fw-bold text-gray-800" th:text="${estadisticas.activas}"></div>
                                <div class="mt-2">
                                    <span class="text-success fw-bold" 
                                          th:text="${estadisticas.total > 0 ? ((estadisticas.activas / estadisticas.total) * 100).intValue() + '%' : '0%'}">
                                    </span>
                                    <span class="text-muted">del total</span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-user-check fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alumnas Inactivas -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-start-warning border-3 h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                                    Alumnas Inactivas
                                </div>
                                <div class="h5 mb-0 fw-bold text-gray-800" th:text="${estadisticas.inactivas}"></div>
                                <div class="mt-2">
                                    <span class="text-warning fw-bold"
                                          th:text="${estadisticas.total > 0 ? ((estadisticas.inactivas / estadisticas.total) * 100).intValue() + '%' : '0%'}">
                                    </span>
                                    <span class="text-muted">del total</span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-user-clock fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registros Este Mes -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-start-info border-3 h-100">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-xs fw-bold text-info text-uppercase mb-1">
                                    Nuevas Este Mes
                                </div>
                                <div class="h5 mb-0 fw-bold text-gray-800" th:text="${estadisticas.esteMes}"></div>
                                <div class="mt-2 text-sm">
                                    <span class="text-info">
                                        <i class="fas fa-trending-up me-1"></i>
                                        <strong th:text="${estadisticas.esteMes}"></strong> registros
                                    </span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos y Análisis -->
        <div class="row">
            <!-- Gráfico de Estado -->
            <div class="col-xl-6 col-lg-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-white py-3">
                        <h6 class="m-0 fw-bold text-primary">
                            <i class="fas fa-chart-pie me-2"></i>Distribución por Estado
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-pie pt-4 pb-2">
                            <canvas id="estadoChart" width="400" height="200"></canvas>
                        </div>
                        <div class="mt-4 text-center small">
                            <span class="me-3">
                                <i class="fas fa-circle text-success"></i> Activas
                            </span>
                            <span>
                                <i class="fas fa-circle text-warning"></i> Inactivas
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registros por Mes -->
            <div class="col-xl-6 col-lg-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-white py-3">
                        <h6 class="m-0 fw-bold text-primary">
                            <i class="fas fa-chart-bar me-2"></i>Registros por Mes
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-bar pt-4 pb-2">
                            <canvas id="registrosChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Datos Mensuales -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="m-0 fw-bold text-primary">
                            <i class="fas fa-table me-2"></i>Detalle de Registros Mensuales
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="dataTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mes</th>
                                        <th>Registros</th>
                                        <th>Porcentaje</th>
                                        <th>Tendencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="dato, stat : ${alumnasPorMes}">
                                        <td>
                                            <strong th:text="${#temporals.monthName(dato[0])}"></strong>
                                            <small class="text-muted d-block" th:text="'Año: ' + ${#temporals.year(T(java.time.LocalDate).now())}"></small>
                                        </td>
                                        <td>
                                            <span class="fw-bold fs-5" th:text="${dato[1]}"></span>
                                            <small class="text-muted d-block">alumnas</small>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-info" 
                                                     role="progressbar" 
                                                     th:attr="style='width: ' + ${estadisticas.total > 0 ? (dato[1] / estadisticas.total * 100) : 0} + '%;'"
                                                     th:aria-valuenow="${dato[1]}" 
                                                     aria-valuemin="0" 
                                                     th:aria-valuemax="${estadisticas.total}">
                                                    <span th:text="${estadisticas.total > 0 ? ((dato[1] / estadisticas.total) * 100).intValue() : 0} + '%'"></span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span th:if="${stat.index > 0 and dato[1] > alumnasPorMes[stat.index-1][1]}" 
                                                  class="badge bg-success">
                                                <i class="fas fa-arrow-up"></i> ↑
                                            </span>
                                            <span th:if="${stat.index > 0 and dato[1] < alumnasPorMes[stat.index-1][1]}" 
                                                  class="badge bg-danger">
                                                <i class="fas fa-arrow-down"></i> ↓
                                            </span>
                                            <span th:if="${stat.index == 0 or dato[1] == alumnasPorMes[stat.index-1][1]}" 
                                                  class="badge bg-secondary">
                                                <i class="fas fa-minus"></i> →
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <th>Total General</th>
                                        <th th:text="${estadisticas.total}"></th>
                                        <th>100%</th>
                                        <th>-</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones Rápidas -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-bolt me-2"></i>Acciones Rápidas
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <a th:href="@{/alumnas/nuevo}" class="btn btn-success w-100">
                                    <i class="fas fa-plus me-2"></i>Nueva Alumna
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a th:href="@{/alumnas/activas}" class="btn btn-outline-success w-100">
                                    <i class="fas fa-user-check me-2"></i>Ver Activas
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <form th:action="@{/alumnas/desactivar-antiguas}" method="post" class="d-grid">
                                    <button type="submit" class="btn btn-outline-warning">
                                        <i class="fas fa-clock me-2"></i>Limpiar Inactivas
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a th:href="@{/alumnas}" class="btn btn-primary w-100">
                                    <i class="fas fa-list me-2"></i>Ver Todas
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información del Sistema -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                        <h5 class="text-primary">Sistema McAulley - Dashboard</h5>
                        <p class="text-muted mb-0">
                            Última actualización: <span id="fechaActual"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Obtener datos desde atributos data-*
        const totalAlumnas = parseInt(document.body.getAttribute('data-total') || '0');
        const activas = parseInt(document.body.getAttribute('data-activas') || '0');
        const inactivas = parseInt(document.body.getAttribute('data-inactivas') || '0');
        
        // Gráfico de Estado (Pie Chart)
        const estadoCtx = document.getElementById('estadoChart').getContext('2d');
        const estadoChart = new Chart(estadoCtx, {
            type: 'pie',
            data: {
                labels: ['Alumnas Activas', 'Alumnas Inactivas'],
                datasets: [{
                    data: [activas, inactivas],
                    backgroundColor: ['#198754', '#ffc107'],
                    hoverBackgroundColor: ['#157347', '#e0a800'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = totalAlumnas;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Gráfico de Registros por Mes (Bar Chart)
        const registrosCtx = document.getElementById('registrosChart').getContext('2d');
        
        // Preparar datos para el gráfico de barras
        const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        
        // Datos de ejemplo - en una implementación real estos vendrían del backend
        const datosMensuales = [5, 8, 12, 7, 15, 10, 18, 14, 9, 11, 13, 16];
        
        const registrosChart = new Chart(registrosCtx, {
            type: 'bar',
            data: {
                labels: meses,
                datasets: [{
                    label: 'Registros por Mes',
                    data: datosMensuales,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Mostrar fecha actual
        function actualizarFecha() {
            const ahora = new Date();
            const opciones = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit' 
            };
            document.getElementById('fechaActual').textContent = 
                ahora.toLocaleDateString('es-ES', opciones) + ' ' + 
                ahora.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
        }
        
        actualizarFecha();

        // Auto-dismiss alerts
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                if (alert.classList.contains('alert-dismissible')) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            });
        }, 5000);

        // Actualizar automáticamente cada 5 minutos
        setTimeout(function() {
            window.location.reload();
        }, 300000); // 5 minutos
    </script>
</body>
</html>