<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Inscripción</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-user-plus me-2"></i>Nueva Inscripción</h1>
            <a th:href="@{/inscripciones}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Volver a Inscripciones
            </a>
        </div>

        <!-- Alertas -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Formulario -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Información de la Inscripción
                </h5>
            </div>
            <div class="card-body">
                <form th:action="@{/inscripciones/guardar}" method="post" th:object="${inscripcion}">
                    
                    <div class="row">
                        <!-- Alumna - CORREGIDO -->
                        <div class="col-md-6 mb-3">
                            <label for="alumna" class="form-label">Alumna *</label>
                            <select class="form-select" id="alumna" name="alumna.idAlumna" required>
                                <option value="">Seleccione una alumna</option>
                                <option th:each="alumna : ${alumnas}" 
                                        th:value="${alumna.idAlumna}"
                                        th:text="${alumna.nombre + ' ' + alumna.apellido + ' (DNI: ' + alumna.dni + ')'}"
                                        th:selected="${inscripcion.alumna != null and inscripcion.alumna.idAlumna == alumna.idAlumna}">
                                </option>
                            </select>
                            <div class="form-text">Seleccione la alumna a inscribir</div>
                        </div>

                        <!-- Horario - CORREGIDO -->
                        <div class="col-md-6 mb-3">
                            <label for="horario" class="form-label">Horario *</label>
                            <select class="form-select" id="horario" name="horario.idHorario" required>
                                <option value="">Seleccione un horario</option>
                                <option th:each="horario : ${horarios}" 
                                        th:value="${horario.idHorario}"
                                        th:text="${horario.curso.nombre + ' - ' + horario.diaSemana + ' ' + #temporals.format(horario.horaInicio, 'HH:mm') + ' a ' + #temporals.format(horario.horaFin, 'HH:mm') + ' (Cupos: ' + horario.cuposDisponibles + ')'}"
                                        th:disabled="${horario.cuposDisponibles <= 0}"
                                        th:selected="${inscripcion.horario != null and inscripcion.horario.idHorario == horario.idHorario}">
                                </option>
                            </select>
                            <div class="form-text" id="infoCupos"></div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Estado de Pago - CORREGIDO -->
                        <div class="col-md-6 mb-3">
                            <label for="estadoPago" class="form-label">Estado de Pago</label>
                            <select class="form-select" id="estadoPago" name="estadoPago.idEstadoPago">
                                <option value="">Seleccione estado de pago</option>
                                <option th:each="estado : ${estadosPago}" 
                                        th:value="${estado.idEstadoPago}"
                                        th:text="${estado.nombreEstado}"
                                        th:selected="${inscripcion.estadoPago != null and inscripcion.estadoPago.idEstadoPago == estado.idEstadoPago}">
                                </option>
                            </select>
                            <div class="form-text">Estado inicial del pago</div>
                        </div>

                        <!-- Fecha de Inscripción -->
                        <div class="col-md-6 mb-3">
                            <label for="fechaInscripcion" class="form-label">Fecha de Inscripción</label>
                            <input type="date" class="form-control" id="fechaInscripcion" name="fechaInscripcion"
                                   th:value="${inscripcion.fechaInscripcion != null ? inscripcion.fechaInscripcion : #temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}">
                            <div class="form-text">Fecha en que se realiza la inscripción</div>
                        </div>
                    </div>

                    <!-- Activo - CORREGIDO -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" 
                                   id="activo" name="activo" th:checked="${inscripcion.activo != null ? inscripcion.activo : true}">
                            <label class="form-check-label" for="activo">
                                Inscripción Activa
                            </label>
                        </div>
                        <div class="form-text">Desactive si la inscripción está cancelada</div>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-between mt-4">
                        <a th:href="@{/inscripciones}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>Registrar Inscripción
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const horarioSelect = document.getElementById('horario');
            const infoCupos = document.getElementById('infoCupos');

            function actualizarInfoCupos() {
                const selectedOption = horarioSelect.options[horarioSelect.selectedIndex];
                if (selectedOption.value) {
                    const texto = selectedOption.text;
                    const match = texto.match(/Cupos: (\d+)/);
                    if (match) {
                        const cupos = parseInt(match[1]);
                        if (cupos <= 0) {
                            infoCupos.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> No hay cupos disponibles</span>';
                        } else {
                            infoCupos.innerHTML = `<span class="text-success"><i class="fas fa-check"></i> ${cupos} cupos disponibles</span>`;
                        }
                    }
                } else {
                    infoCupos.innerHTML = '';
                }
            }

            horarioSelect.addEventListener('change', actualizarInfoCupos);
            actualizarInfoCupos(); // Ejecutar al cargar la página
        });
    </script>
</body>
</html>